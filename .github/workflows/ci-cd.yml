name: CI/CD Pilot  # Имя пайплайна

on:  # Когда запускать
  push:  # На каждый push
    branches: [master] 
  pull_request:  # На PR
    branches: [master]

jobs:
  build:  # Job 1: Сборка
    runs-on: ubuntu-latest  # На Linux (для C++)
    steps:
      - uses: actions/checkout@v4  # Скачивает код
      - name: Установка зависимостей
        run: |
          sudo apt update
          sudo apt install cmake g++
      - name: Сборка проекта
        run: |
          echo "=== Сборка проекта ==="
          cmake .
          make
          make unit_tests
          echo "Сборка завершена ✅"
      - name: Сохранить артефакты (built files)
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            CI_CD_Pilot
            unit_tests

  test:  # Job 2: Тесты (пока заглушка, добавим реальные позже)
    runs-on: ubuntu-latest
    needs: build  # Запускается после успешной сборки
    steps:
      - uses: actions/checkout@v4
      - name: Скачать артефакты
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
      - name: Запуск тестов
        run: |
          echo "=== Автотесты ==="
          chmod +x unit_tests  # Make exe runnable on Linux
          ./unit_tests  # Run; if fail — red with GTest log
          echo "Тесты прошли ✅"

  deploy:  # Job 3: Деплой (заглушка)
    runs-on: ubuntu-latest
    needs: test  # После тестов
    if: github.ref == 'refs/heads/main'  # Только на main
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: build-artifacts
      - name: Деплой
        run: |
          echo "=== Деплой на сервер ==="
          echo "Здесь будет реальный деплой (e.g. scp built_file to server)"
